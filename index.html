<!DOCTYPE html>
<html>
<head>
<title>Occupy Streams Map</title>
<link rel="stylesheet" href="css/olwidget.css" />
<style type='text/css'>
    html,body {
        position: relative;
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Helvetica Neue","Liberation Sans",Arial,Verdana,Helvetica,FreeSans,sans-serif;
        text-transform: uppercase;
    }
    a:link { color: #760000; text-decoration: none;}
    a:hover { color: #000000 }
    a:visited { color: #960000; text-decoration: none; }
    .olwidgetPopupContent { text-align: center; }
    .title {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        text-align: center;
        font-size: 38pt;
        z-index: 1000;
        font-weight: bold;
        text-shadow: #999 2px -2px 5px;
    }
</style>
</head>
<body>
<div id='map'></div>
<div class='title'>
    <span style='color: #900;'>OCCUPY</span>
    <span style='color: #000;'>STREAMS</span>
    <span style='color: #999'>MAP</span>
</div>
<script src='js/jquery.min.js'></script>
<script src='http://openlayers.org/api/2.11/OpenLayers.js'></script>
<script src='http://openstreetmap.org/openlayers/OpenStreetMap.js'></script>
<script src='js/olwidget.js' type='text/javascript'></script>
<script type='text/javascript' src='data.js'></script>
<script type='text/javascript'>
var generators = {
    "livestream": function(source) {
        return {
            style: {
                externalGraphic: "http://thumbnail.api.livestream.com/thumbnail?name=" + source.id,
                backgroundGraphic: null,
                graphicWidth: 24,
                graphicHeight: 18
            },
            html: ["<h2><a href='", source.url, "'>", source.location, "</a></h2>",
                "<a href='", source.url, "'><img class='livestreamthumb' src='http://thumbnail.api.livestream.com/thumbnail?name=", source.id, "' style='width: 240px; height: 180px'></a>"
           ].join("")
        }
    },
    "ustream": function(source) {
        return {
            style: {
                externalGraphic: "img/ustream.jpg",
                backgroundGraphic: null,
                graphicWidth: 25,
                graphicHeight: 25,
            },
            html: ["<h2><a href='", source.url, "'>", source.location, "</a></h2>", "<a href='", source.url, "'><img src='img/ustream.jpg'></a>"].join("")
        }
    }
};
var infodata = [];
var overlaps = {};
for (var i = 0; i < data.sources.length; i++) {
    var source = data.sources[i];
    var lat = source.point.lat;
    var lng = source.point.lng;
    while (overlaps[[lat, lng].join(" ")]) {
        lng += 0.1;
    }
    overlaps[[lat, lng].join(" ")] = true;
    var geom = "POINT(" + lng + " " + lat + ")";
    infodata.push([geom, generators[source.provider](source)]);
}
new olwidget.InfoMap('map', infodata, {
    mapDivStyle: {
        width: '100%',
        height: '100%',
        overflow: 'hidden'
    }
});
window.setInterval(function() {
    $("img.livestreamthumb").each(function() {
        var img = $(this);
        if (img.is(":visible")) {
            var oldSrc = img.attr("src"); 
            oldSrc = oldSrc.split("&t=")[0];
            img.attr("src", oldSrc + "&t=" + new Date().valueOf());
        }
    });
}, 1000);
</script>
</body>
</html>
